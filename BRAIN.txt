# BRAIN Snapshot · Updated 2025-11-03

## Repository Overview
- Mono-repo for OpenGuild: Rust (Axum) backend under `backend/`, Vue 3 + Vite web client under `frontend/`, supporting docs in `docs/`.
- Development workflow standardised around `cargo xtask` for backend chores and `bun` scripts for the frontend (`dev`, `lint`, `test:unit`, `type-check`, `build`).
- Environment configuration follows “config file → env vars → CLI flags” on the server side; the client targets `VITE_API_BASE_URL`.

## Backend (Rust / Axum)
- **Authentication & Sessions**
  - `/users/register`, `/sessions/login`, `/sessions/refresh`, `/sessions/revoke` exposed; sessions emit Ed25519-signed access tokens and refresh tokens bound to `device_id`.
  - Device metadata persisted when storage is available; refresh rotation with revocation on mismatches.
- **Messaging Core**
  - REST: `/guilds`, `/guilds/{guild_id}/channels`, `/channels/{channel_id}/messages`, `/channels/{channel_id}/events`.
  - WebSocket fan-out at `/channels/{channel_id}/ws` with backpressure, replay window, global connection semaphore, sender validation, and rate limits (per-user & per-IP).
  - Validation caps: guild/channel names <= 64 chars, message content <= 4,000 chars; rejections instrumented via metrics.
- **Federation (Week 8 groundwork)**
  - `FederationService`, trusted server list, `/federation/transactions` ingress, `/federation/channels/{channel_id}/events` for remote pagination.
  - Canonical event envelope carries `schema_version` and BLAKE3-derived IDs.
- **Observability & Ops**
  - Request ID middleware propagates across logs/metrics; optional Prometheus exporter, health (`/ready`, `/health`), version route.
  - Security headers (CSP, Referrer-Policy, etc.) enforced globally.
  - SQLx storage layer with migration smoke tests (`cargo xtask ci-metrics-smoke`, `cargo xtask test`).
  - CLI overrides for bind address, metrics, messaging rate limits, database URL, server name.
  - Threat model and operations playbooks documented under `docs/`.

## Frontend (Vue 3 / Vite)
- **Foundation (Weeks 1–3 complete)**
  - Vue 3 + Pinia + TypeScript, Tailwind tokens, Nuxt UI component library, Vite aliases (`@/`, `~/`).
  - Session store handles login/register, token refresh, device metadata, secure persistence.
  - Auth views include validation, onboarding carousel with links to `docs/SETUP.md`, `docs/FRONTEND_TIMELINE.md`, `docs/TESTING.md`.
  - Layouts: `DefaultLayout.vue` for authenticated shell, `AuthLayout.vue` for login/register.
- **Week 4 Progress (current focus)**
  - Guild rail and channel sidebar hydrate from backend `/guilds` + `/guilds/{id}/channels`; skeleton states during load.
  - Guild creation modal (`AppGuildCreateModal.vue`) posts to `/guilds`, updates Pinia state, and guides the user through empty states.
  - Query-param sync (`?guild=&channel=`) keeps deep links stable; selection handlers propagate through Pinia.
  - New `useTimelineStore` + `AppMessageTimeline` render `/channels/{id}/events`, group messages by day, and expose manual refresh alongside reactions/system placeholders.
  - Home dashboard refreshed with live metrics, Week 4 delivery log, invite-only alerts, and upcoming tasks.
  - Outstanding: channel creation modal, deeper empty-state flows, timeline virtualization and reaction interactivity (tracked in docs).
- **Additional UI**
  - Styleguide view for tokens/components, roadmap view, home status cards wired to system store (`/ready`, `/version`).

## Testing & Tooling
- **Backend**
  - `cargo xtask test` (workspace), `cargo xtask ci`, `cargo xtask ci-metrics-smoke`.
  - Targeted suites for config, readiness, messaging, federation documented in `docs/TESTING.md`.
- **Frontend**
  - `bun test:unit` (Vitest, jsdom). Projects for Storybook+Playwright remain opt-in via `STORYBOOK_TESTS=true`.
  - New store coverage: `frontend/src/stores/__tests__/session.spec.ts`, `guilds.spec.ts`, `channels.spec.ts`, `timeline.spec.ts`.
  - `bun run type-check` (vue-tsc) covers the Vite client.
- **Docs**
  - `docs/FRONTEND_TIMELINE.md` tracks week-by-week UI milestones; Week 4 items updated for latest work.
  - `docs/TESTING.md` links backend/ frontend commands and coverage responsibilities.
  - `BRIEF.md` describes product framing; `docs/OBSERVABILITY.md`, `docs/THREATMODEL.md`, `docs/OPERATIONS.md` detail ops posture.

## Deployment Notes
- Backend expects Postgres (`DATABASE_URL`) but can operate in in-memory mode for local dev; metrics optional via feature flag.
- Frontend served by Vite dev server (`bun dev`), built assets with `bun run build`.
- Docker Compose sets baseline env (`OPENGUILD_SERVER__SERVER_NAME=dev.openguild.local`) for local federation experiments.

## Current Focus & Next Steps
- Finish Week 4 UX parity: guild creation modal, invite-only / empty states, reaction placeholders.
- Begin Week 5 preparations: message composer, optimistic posting, WebSocket integration on the client.
- Maintain parity between frontend docs/tests and backend milestones; keep `docs/FRONTEND_TIMELINE.md` synced after each push.
