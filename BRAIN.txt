# BRAIN Snapshot · Updated 2025-11-04

## Repository Overview
- OpenGuild mono-repo: Rust (Axum) backend under `backend/`, Vue 3 + Vite frontend under `frontend/`, shared documentation in `docs/`.
- Development workflow: `cargo xtask` orchestrates backend chores; frontend uses Bun/NPM parity scripts (`dev`, `lint`, `test:unit`, `type-check`, `build`).
- Config strategy: backend honours config files → env vars → CLI flags; frontend consumes `VITE_API_BASE_URL` via `frontend/src/config/runtime.ts`.

## Backend (Rust / Axum)
- **Auth & Sessions**
  - REST surface includes `/users/register`, `/sessions/login`, `/sessions/refresh`, `/sessions/revoke`; tokens are Ed25519-signed and bound to `device_id`.
  - Device metadata persisted when storage is available; refresh rotation handles expiry + revocation.
- **Messaging Core**
  - REST endpoints: `/guilds`, `/guilds/{guild_id}/channels`, `/channels/{channel_id}/messages`, `/channels/{channel_id}/events` (pagination + limits enforced).
  - WebSocket fan-out at `/channels/{channel_id}/ws` implements replay window, heartbeats, global connection semaphore, sender validation, and per-IP/user rate limits. Fallback now accepts `?access_token=` when the browser cannot set headers, while still preferring `Authorization`.
  - Validation thresholds: guild/channel names ≤ 64 chars, message bodies ≤ 4 000 chars; metrics track rejection reasons.
- **Federation Plumbing**
  - `FederationService` backs `/federation/transactions` ingress and `/federation/channels/{channel_id}/events`; canonical events include schema version + signatures for future MLS integrations.
- **Observability & Ops**
  - Request IDs flow through logs/metrics; optional Prometheus exporter, `/ready` and `/health` probes, `/version` for build info.
  - Security headers enforced globally; SQLx storage with smoke tests (`cargo xtask ci-metrics-smoke`).

## Frontend (Vue 3 / Vite)
- **Foundations & Working Assumptions (Weeks 0–2)**
  - Vue 3 + Pinia + TypeScript in Vite, Tailwind tokens + Nuxt UI components, documented aliases (`@/`, `~/`).
  - `frontend/src/composables/useApiClient.ts` ensures request IDs, auth propagation, and telemetry breadcrumbs. Vitest suites (`frontend/tests/accessibility.test.ts`, store specs) guard regressions.
  - Accessibility, responsive layout, and instrumentation (Sentry stubs, LogRocket hooks, Lighthouse budgets) are treated as baseline requirements.
- **Auth & Onboarding (Week 3)**
  - Session store handles login/register, secure persistence, silent refresh, and device metadata prompts. Views live at `LoginView.vue` / `RegisterView.vue`; onboarding carousel links core docs.
  - Global route guards enforce auth, refresh tokens, and redirect unauthenticated users to `/login`.
- **Guild & Channel Shell (Week 4)**
  - Pinia stores hydrate guild rail + channel sidebar from `/guilds` and `/guilds/{id}/channels`, with skeleton and invite-only states.
  - Creation modals (`AppGuildCreateModal.vue`, `AppChannelCreateModal.vue`) post to the backend and reconcile Pinia state; timeline scaffold via `useTimelineStore` + `AppMessageTimeline.vue` handles grouped events and manual refresh.
- **Messaging & Realtime (Week 5)**
  - `AppMessageComposer.vue` delivers multi-line input, optimistic queueing, and connectivity banners; `useMessageComposerStore` manages optimistic events, retry queues, and backend validation (using the authenticated user ID for POSTs).
  - `useRealtimeStore` adds exponential backoff, heartbeats, visibility-aware pause/resume, typing-preview emission (WebSocket first, HTTP fallback), and Sentry breadcrumbs.
  - Home dashboard (`HomeView.vue`) wires in realtime status, typing previews, retry hooks, and degraded connectivity alerts. Lighthouse performance budgets live at `frontend/lighthouse.budgets.json`.
- **Security & Accessibility (Weeks 6–7)**
  - Role-aware permissions live in `frontend/src/utils/permissions.ts`; `DefaultLayout.vue` and `AppChannelSidebar.vue` gate channel creation with user guidance, while `HomeView.vue` blocks the composer for read-only members and surfaces an admin-only panel behind `VITE_FEATURE_ADMIN_PANEL`.
  - Device inventory hydrates via `frontend/src/stores/devices.ts`, falling back to mock data until `/sessions/devices` lands. Session persistence now uses `frontend/src/utils/storage.ts` to audit storage capabilities, exposing `storageAudit` in the session overview.
  - Accessibility upgrades include focusable timeline items and an axe-core regression test (`frontend/tests/accessibility.test.ts`); keyboard/screen-reader/manual plans captured in `docs/TESTING.md`.

## Testing & Tooling
- **Backend**: `cargo xtask test`, `cargo xtask ci`, `cargo xtask ci-metrics-smoke`; targeted messaging/federation suites documented in `docs/TESTING.md`.
- **Frontend**: `bun test:unit` (Vitest, jsdom, axe-core), `bun run type-check` (vue-tsc). Storybook/Playwright remain optional via `STORYBOOK_TESTS=true`.
- Docs to watch: `docs/FRONTEND_TIMELINE.md` (timeline synced through Week 7), `docs/TESTING.md`, product brief (`BRIEF.md`), observability/threat model references.

## Deployment Notes
- Backend defaults to Postgres (`DATABASE_URL`) but supports in-memory fallback for local dev; metrics exporter is feature gated.
- Frontend served via Vite dev server (`bun dev`), production assets with `bun run build`. Docker Compose seeds local env (`OPENGUILD_SERVER__SERVER_NAME`) for federation experiments.

## Current Focus & Next Steps
- Weeks 0–7 are complete; upcoming work moves into Week 8 federation features and MLS prep.
- Maintain parity between backend capabilities and frontend docs/tests, and continue logging realtime/messaging telemetry for observability.
